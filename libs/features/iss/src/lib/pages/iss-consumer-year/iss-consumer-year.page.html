<!-- libs/features/iss/src/lib/pages/iss-consumer-year/iss-consumer-year.page.html -->

<section class="iss-year">
  <!-- Header -->
  <header class="iss-year__header">
    <button type="button" class="iss-year__back" (click)="backToHome()">
      ← Back to ISS home
    </button>

    <div class="iss-year__header-main">
      <div class="iss-year__title-block">
        <h1>{{ consumerName$ | async }}</h1>
        <p>Weekly ISS staff logs – year view, grouped by month</p>
      </div>

      <!-- NEW: simple actions row with Add button -->
      <div class="iss-year__actions">
        <button
          type="button"
          class="iss-year__add-btn"
          (click)="openAddOverlay()"
        >
          + Add weekly log
        </button>
      </div>
    </div>
  </header>

  <!-- Main grid: month cards with existing week links -->
  <ng-container *ngIf="months$ | async as months; else loading">
    <section class="iss-year__grid" *ngIf="months.length; else empty">
      <article class="month-card" *ngFor="let m of months">
        <header class="month-card__header">
          <div>
            <h2>{{ m.monthStart | date: 'MMMM' }}</h2>
            <p class="month-card__subtitle">
              {{ m.monthStart | date: 'y' }} &middot;
              {{ m.weeks.length }} week{{ m.weeks.length > 1 ? 's' : '' }}
            </p>
          </div>
        </header>

        <div class="month-card__weeks">
          <button
            type="button"
            class="week-pill"
            *ngFor="let w of m.weeks"
            (click)="openWeek(w.serviceDate)"
            [ngClass]="statusClass(w)"
          >
            <div class="week-pill__main">
              <span class="week-pill__label">
                Week of {{ w.serviceDate | date: 'MMM d' }}
              </span>

              <span class="week-pill__status">
                <ng-container *ngIf="w.hasLog; else noLog">
                  {{ w.status || 'draft' }}
                </ng-container>
                <ng-template #noLog>empty</ng-template>
              </span>
            </div>

            <span class="week-pill__meta" *ngIf="w.totalHours">
              {{ w.totalHours }} hrs
            </span>
          </button>
        </div>
      </article>
    </section>
  </ng-container>

  <!-- Loading / empty states -->
  <ng-template #loading>
    <p class="iss-year__status">Loading weekly logs…</p>
  </ng-template>

  <ng-template #empty>
    <div class="iss-year__empty-card">
      <p class="iss-year__status">
        No weekly ISS staff logs yet for this consumer.
      </p>

      <p class="iss-year__hint">
        Click <strong>“Add weekly log”</strong> to choose a month and week for
        the first staff log, or start with the current week:
      </p>

      <button
        type="button"
        class="iss-year__start-btn"
        (click)="startFirstLog()"
      >
        Start with current week
      </button>
    </div>
  </ng-template>

  <!-- Shared "no log" template used inside the *ngFor -->
  <ng-template #noLog>empty</ng-template>

  <!-- =========================
       ADD WEEK OVERLAY
       ========================= -->
  <div
    class="iss-year__add-overlay"
    *ngIf="isAddOverlayOpen"
  >
    <div class="iss-year__add-card">
      <header class="iss-year__add-header">
        <h2>Add weekly ISS staff log</h2>
        <p>
          Choose a <strong>month</strong> on the left, then pick an available
          <strong>week</strong> to start a new log. Weeks that already have a
          staff log are disabled.
        </p>
      </header>

      <div class="iss-year__add-body">
        <!-- Month rail -->
        <div class="iss-year__add-months">
          <button
            type="button"
            class="add-month"
            *ngFor="let m of monthOptions"
            [class.add-month--selected]="selectedAddMonth === m.value"
            [class.add-month--full]="isMonthFull(m.value)"
            (click)="onAddMonthClick(m.value)"
          >
            <span class="add-month__label">
              {{ m.label }}
            </span>
            <span class="add-month__tag" *ngIf="isMonthFull(m.value)">
              All weeks filled
            </span>
          </button>
        </div>

        <!-- Weeks list -->
        <div class="iss-year__add-weeks">
          <p
            class="iss-year__add-hint"
            *ngIf="!selectedAddMonth"
          >
            Select a month on the left to see its weeks.
          </p>

          <ng-container *ngIf="selectedAddMonth !== null">
            <p
              class="iss-year__add-hint"
              *ngIf="!addWeekChoices.length"
            >
              No Mondays found in this month.
            </p>

            <button
              type="button"
              class="add-week"
              *ngFor="let w of addWeekChoices"
              [class.add-week--disabled]="w.hasLog"
              [disabled]="w.hasLog"
              (click)="onAddWeekClick(w)"
            >
              <span class="add-week__label">
                {{ w.label }}
              </span>
              <span
                class="add-week__note"
                *ngIf="w.hasLog"
              >
                Already has a staff log
              </span>
            </button>
          </ng-container>
        </div>
      </div>

      <footer class="iss-year__add-footer">
        <button
          type="button"
          class="btn-cancel"
          (click)="closeAddOverlay()"
        >
          Cancel
        </button>
      </footer>
    </div>
  </div>
</section>